//===================================================================================================================================
//yVisionState.cppz
// [ì¬ŽÒ]HAL“Œ‹žGP12A332 11 ›–ì Ž÷
// [ì¬“ú]2019/11/17
// [XV“ú]2019/11/24
//===================================================================================================================================

//===================================================================================================================================
//yƒCƒ“ƒNƒ‹[ƒhz
//===================================================================================================================================
#include "VisionState.h"
#include "NormalState.h"
#include "DigitalShiftState.h"
#include "SkyVisionState.h"

//===================================================================================================================================
//yusingéŒ¾z
//===================================================================================================================================
using namespace playerNS;
using namespace visionNS;

//===================================================================================================================================
//yƒRƒ“ƒXƒgƒ‰ƒNƒ^z
//===================================================================================================================================
VisionState::VisionState(Player* player):AbstractState()
{
	//‹¤’Ê€–Ú
	this->player = player;
	stateTimer = 0.0f;
	type		= VISION;
	nextType	= NORMAL;
	stateName	= "VISION";
	onTrans		= false;
	player->setValidOperation(
		ENABLE_MOVE |
		ENABLE_JUMP |
		ENABLE_SKY_VISION | 
		ENABLE_CANCEL_VISION);
	//ŒÅ—L€–Ú
	costTimer = 0.0f;		//“d—ÍÁ”ïƒ^ƒCƒ}[

}

//===================================================================================================================================
//yƒfƒXƒgƒ‰ƒNƒ^z
//===================================================================================================================================
VisionState::~VisionState()
{
}

//===================================================================================================================================
//yŠJŽnˆ—z
//===================================================================================================================================
void VisionState::start()
{
	player->effect->play(PlayerEffectNS::EFFECT_LIST::DIGIT_MODE);
}

//===================================================================================================================================
//yXVz
//===================================================================================================================================
void VisionState::update(float frameTime)
{
	this->frameTime = frameTime;
	stateTimer += frameTime;

	//“d—ÍÁ”ï
	costTimer += frameTime;
	if (costTimer > COST_TIME)
	{
		player->addpower(-COST);
		costTimer = 0.0f;
	}

	//ó‘Ô‘JˆÚ
	if (player->cancelVision())				return;		//ƒrƒWƒ‡ƒ“‚ÌƒLƒƒƒ“ƒZƒ‹
	else if (player->skyVision())			return;		//ƒXƒJƒCƒrƒWƒ‡ƒ“
	else if (player->digitalShift())		return;		//ƒfƒWƒ^ƒ‹ƒVƒtƒg
	else if (player->getPower() <= 0)
	{
		player->returnTransitionCamera(0.0f);
		player->transState(NORMAL);		return;	//’Êíó‘Ô
	}
}

//===================================================================================================================================
//y‘€ìz
//===================================================================================================================================
void VisionState::operation()
{
	// ‘€ì
	player->moveOperation();			//ˆÚ“®‘€ì
	player->jumpOperation();			//ƒWƒƒƒ“ƒv‘€ì
}

//===================================================================================================================================
//y•¨—ˆ—z
//===================================================================================================================================
void VisionState::physics()
{
	player->grounding();				// Ú’nˆ—
	player->physicalBehavior();			// •¨—‹““®
	player->updatePhysics(frameTime);	// •¨—‚ÌXV
}

//===================================================================================================================================
//yƒJƒƒ‰‘€ìz
//===================================================================================================================================
void VisionState::controlCamera()
{
	player->transitionCamera();

	player->controlCamera(frameTime);
}

//===================================================================================================================================
//yó‘Ô‘JˆÚz
//===================================================================================================================================
AbstractState* VisionState::transition()
{
	switch (nextType)
	{
	case DIGITAL_SHIFT:
		return new digitalShiftNS::DigitalShiftState(player);
		break;
	case SKY_VISION:
		return new skyVisionNS::SkyVisionState(player);
		break;
	case NORMAL:default:
		return new normalNS::NormalState(player);
		break;
	}
}

//===================================================================================================================================
//yI—¹ˆ—z
//===================================================================================================================================
void VisionState::end()
{
	player->effect->stop(PlayerEffectNS::EFFECT_LIST::DIGIT_MODE);
}


